@model ProyectoIngenieria.Models.ViewModels.HorasTrabajoVM

@{
    ViewData["Title"] = Model.HorasTrabajo.Id == 0 ? "AGREGAR HORAS DE TRABAJO" : "EDITAR HORAS DE TRABAJO";
}


<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="container py-5">
            

            <form asp-action="Upsert" method="post">
                @Html.AntiForgeryToken()

                <input type="hidden" asp-for="HorasTrabajo.Id" />

                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="row g-4">

                            <div class="border-bottom pb-3 mb-4">
                                <h2 class="titulo-formulario">
                                    @ViewData["Title"]
                                </h2>
                            </div>


                            <!-- Vehículo -->
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Vehículo</label>
                                @if (Model.HorasTrabajo.Id == 0 && Model.HorasTrabajo.VehiculoId == 0)
                                {
                                    <select asp-for="HorasTrabajo.VehiculoId"
                                            asp-items="Model.VehiculoList"
                                            class="form-select select2"
                                            data-val="true"
                                            data-val-required="Debe seleccionar un vehículo.">
                                        <option value="">-- Seleccione un vehículo --</option>
                                    </select>
                                    <span asp-validation-for="HorasTrabajo.VehiculoId" class="text-danger small"></span>
                                }
                                else
                                {
                                    <input type="text"
                                           class="form-control"
                                           value="@Model.VehiculoList.FirstOrDefault(v => v.Value == Model.HorasTrabajo.VehiculoId.ToString())?.Text"
                                           disabled />
                                    <input type="hidden" asp-for="HorasTrabajo.VehiculoId" />
                                }
                            </div>

                            <!-- Fecha -->
                            <div class="col-md-6">
                                <label asp-for="HorasTrabajo.Fecha" class="form-label fw-semibold">Fecha del trabajo</label>
                                <input asp-for="HorasTrabajo.Fecha" type="text" class="form-control" id="fechaTrabajo" />
                                <span asp-validation-for="HorasTrabajo.Fecha" class="text-danger small"></span>
                            </div>

                            <!-- Proyecto -->
                            <div class="col-md-6">
                                <label asp-for="HorasTrabajo.ProyectoId" class="form-label fw-semibold">Proyecto</label>
                                <select asp-for="HorasTrabajo.ProyectoId"
                                        asp-items="Model.ProyectoList"
                                        class="form-select select2"
                                        data-val="true"
                                        data-val-required="Debe seleccionar un proyecto.">
                                    <option value="">-- Seleccione un proyecto --</option>
                                </select>
                                <span asp-validation-for="HorasTrabajo.ProyectoId" class="text-danger small"></span>
                            </div>

                            <!-- Lugar de trabajo -->
                            <div class="col-md-6">
                                <label asp-for="HorasTrabajo.LugarTrabajoId" class="form-label fw-semibold">Lugar de Trabajo</label>
                                <select asp-for="HorasTrabajo.LugarTrabajoId"
                                        asp-items="Model.LugarTrabajoList"
                                        class="form-select select2"
                                        data-val="true"
                                        data-val-required="Debe seleccionar un lugar de trabajo.">
                                    <option value="">-- Seleccione un lugar --</option>
                                </select>
                                <span asp-validation-for="HorasTrabajo.LugarTrabajoId" class="text-danger small"></span>
                            </div>


                            <!-- Tipo de trabajo -->
                            <div class="col-md-6">
                                <label asp-for="HorasTrabajo.TipoTrabajoId" class="form-label fw-semibold">Tipo de Trabajo</label>
                                <select asp-for="HorasTrabajo.TipoTrabajoId"
                                        asp-items="Model.TipoTrabajoList"
                                        class="form-select"
                                        data-val="true"
                                        data-val-required="Debe seleccionar un tipo de trabajo.">
                                    <option value="">-- Seleccione un tipo --</option>
                                </select>
                                <span asp-validation-for="HorasTrabajo.TipoTrabajoId" class="text-danger small"></span>
                            </div>

                            <!-- Precio por hora -->
                            <div class="col-md-6">
                                <label asp-for="HorasTrabajo.PrecioHora" class="form-label fw-semibold">Precio de la hora</label>
                                <input asp-for="HorasTrabajo.PrecioHora" class="form-control" type="number" step="0.01" placeholder="0" />
                                <span asp-validation-for="HorasTrabajo.PrecioHora" class="text-danger small"></span>
                            </div>

                            <!-- Horómetro Inicial -->
                            <div class="col-md-6">
                                <label asp-for="HorasTrabajo.HorometroInicial" class="form-label fw-semibold">Horómetro Inicial</label>
                                <input asp-for="HorasTrabajo.HorometroInicial" class="form-control" type="number" step="0.01" placeholder="0" />
                                <span asp-validation-for="HorasTrabajo.HorometroInicial" class="text-danger small"></span>
                            </div>

                            <!-- Horómetro Final -->
                            <div class="col-md-6">
                                <label asp-for="HorasTrabajo.HorometroFinal" class="form-label fw-semibold">Horómetro Final</label>
                                <input asp-for="HorasTrabajo.HorometroFinal" class="form-control" type="number" step="0.01" placeholder="0" />
                                <span asp-validation-for="HorasTrabajo.HorometroFinal" class="text-danger small"></span>
                            </div>

                            <!-- Ingreso estimado (calculado automáticamente) -->
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Ingreso estimado</label>
                                <input type="text" class="form-control" id="ingresoCalculado" readonly />
                            </div>
                        </div>

                       

                        <div class="d-flex justify-content-end gap-2 pt-4">
                            <button type="submit" class="btn btn-success w-25">
                                @(Model.HorasTrabajo.Id == 0 ? "CREAR" : "ACTUALIZAR")
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    @if (Model.HorasTrabajo.VehiculoId != 0)
    {
        <a asp-controller="HorasTrabajo" asp-action="Index" asp-route-id="@Model.HorasTrabajo.VehiculoId"
           class="btn btn-outline-success rounded-circle shadow p-3"
           style="position: fixed; bottom: 30px; right: 30px; z-index: 1050; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
            <i class="bi bi-arrow-left"></i>
        </a>
    }
    else
    {
        <a asp-controller="HorasTrabajo" asp-action="Index"
           class="btn btn-outline-success rounded-circle shadow p-3"
           style="position: fixed; bottom: 30px; right: 30px; z-index: 1050; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
            <i class="bi bi-arrow-left"></i>
        </a>
    }
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <!-- Flatpickr JS + idioma español -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>

    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />

    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


    <script>

        $(document).ready(function () {
            $('.select2').select2({
                width: '100%',
                placeholder: '-- Seleccione una opción --',
                allowClear: true,
                language: "es"
            });
        });

        flatpickr("#fechaTrabajo", {
            locale: "es",
            dateFormat: "Y-m-d",
            defaultDate: "@Model.HorasTrabajo.Fecha.ToString("yyyy-MM-dd")"
        });



        function calcularIngreso() {
            const precioHora = parseFloat(document.getElementById("HorasTrabajo_PrecioHora").value) || 0;
            const horometroInicial = parseFloat(document.getElementById("HorasTrabajo_HorometroInicial").value) || 0;
            const horometroFinal = parseFloat(document.getElementById("HorasTrabajo_HorometroFinal").value) || 0;

            const horasTrabajadas = horometroFinal - horometroInicial;
            const ingreso = horasTrabajadas > 0 ? horasTrabajadas * precioHora : 0;

            document.getElementById("ingresoCalculado").value = `₡${ingreso.toFixed(2)}`;
        }

        // Detectar cambios en los campos y recalcular
        document.getElementById("HorasTrabajo_PrecioHora").addEventListener("input", calcularIngreso);
        document.getElementById("HorasTrabajo_HorometroInicial").addEventListener("input", calcularIngreso);
        document.getElementById("HorasTrabajo_HorometroFinal").addEventListener("input", calcularIngreso);

        // Cálculo inicial al cargar la vista
        window.addEventListener("DOMContentLoaded", calcularIngreso);
    </script>
}
