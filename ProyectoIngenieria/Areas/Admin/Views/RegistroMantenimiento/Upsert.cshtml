@model ProyectoIngenieria.Models.ViewModels.RegistroMantenimientoVM
@{
    ViewData["Title"] = "Registrar Mantenimiento";
    var opcionesOperadores = Model.ListaOperadores != null
        ? string.Join("", Model.ListaOperadores.Select(o => $"<option value='{o.Value}'>{o.Text}</option>"))
        : "";
    var opcionesTareas = Model.ListaCatalogoMantenimiento ?? new List<SelectListItem>();
}


<div class="container-fluid mt-5">
    <div class="card shadow border-0 mx-auto" style="max-width: 100%; width: 95%;">
        <div class="card-body">
            <div class="border-bottom pb-3 mb-4">
                <h2 class="titulo-formulario">
                    REGISTRAR MANTENIMIENTO
                </h2>
            </div>

            <form asp-action="Upsert" method="post">
                <input asp-for="RegistroMantenimiento.Id" type="hidden" />
                @Html.ValidationSummary(true, "", new { @class = "text-danger" })

                <!-- Encabezado con datos generales -->
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Vehículo</label>
                        @if (Model.RegistroMantenimiento.Id == 0 && Model.RegistroMantenimiento.VehiculoId == 0)
                        {
                            <select asp-for="RegistroMantenimiento.VehiculoId"
                                    asp-items="Model.ListaVehiculos"
                                    class="form-select select2"
                                    data-val="true"
                                    data-val-required="Debe seleccionar un vehículo.">
                                <option value="">-- Seleccione un vehículo --</option>
                            </select>
                            <span asp-validation-for="RegistroMantenimiento.VehiculoId" class="text-danger small"></span>
                        }
                        else
                        {
                            <input type="text"
                                   class="form-control"
                                   value="@Model.ListaVehiculos.FirstOrDefault(v => v.Value == Model.RegistroMantenimiento.VehiculoId.ToString())?.Text"
                                   disabled />
                            <input type="hidden" asp-for="RegistroMantenimiento.VehiculoId" />
                        }
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Fecha</label>
                        <input asp-for="RegistroMantenimiento.Fecha" type="date" class="form-control" id="fechaMantenimiento" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Precio</label>
                        <input asp-for="RegistroMantenimiento.Precio" type="number" step="0.01" class="form-control" />
                        @Html.ValidationMessage("RegistroMantenimiento.Precio", "", new { @class = "text-danger" })
                    </div>
                </div>

                <!-- Descripción -->
                <div class="mb-4">
                    <label class="form-label fw-semibold">Descripción</label>
                    <textarea asp-for="RegistroMantenimiento.Descripcion" class="form-control" rows="2" placeholder="Ingrese una descripción detallada..."></textarea>
                    <span asp-validation-for="RegistroMantenimiento.Descripcion" class="text-danger small"></span>
                </div>

                <!-- Cuerpo dividido en dos columnas -->
                <div class="row">
                    <!-- Actividades y operadores -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Operarios y actividades realizadas</label>
                            @* agrega una referencia al upset del operador para permitir tener un acceso rapido y crear un operador *@
                                                      <br />
                            <button type="button" class="btn btn-outline-primary btn-sm mb-2" onclick="abrirModalActividades()"><i class="bi bi-plus-circle me-1"></i>ACTIVIDADES</button>
                            @Html.ValidationMessage("DetallesOperadores", "", new { @class = "text-danger" })

                            <a asp-controller="Operador" asp-action="Upsert" class="btn btn-outline-primary btn-sm mb-2">
                                <i class="bi bi-plus-circle me-1"></i> NUEVO OPERADOR
                            </a>
                            <div style="max-height: 250px; overflow-y: auto;">
                                <table class="table table-sm table-bordered" id="tablaActividadesSeleccionadas">
                                    <thead>
                                        <tr>
                                            <th>NOMBRE</th>
                                            <th>OPERADOR</th>
                                            <th>HORAS</th>
                                            <th style="background-color:white">ACCIÓN</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @{
                                            var index = 0;
                                        }
                                        @foreach (var detalle in Model.DetallesOperadores ?? new List<OperadorMantenimiento>())
                                        {
                                            var actividad = Model.ListaCatalogoMantenimiento.FirstOrDefault(a => a.Value == detalle.CatalogoMantenimientoId.ToString());
                                            var operador = Model.ListaOperadores.FirstOrDefault(o => o.Value == detalle.OperadorCedula.ToString());
                                            if (actividad != null && operador != null)
                                            {
                                                <tr id="actividad-@detalle.CatalogoMantenimientoId-@index">
                                                    <td>
                                                        @actividad.Text
                                                        <input type="hidden" name="DetallesOperadores[@index].CatalogoMantenimientoId" value="@detalle.CatalogoMantenimientoId" />
                                                    </td>
                                                    <td>
                                                        <select class="form-select form-select-sm" name="DetallesOperadores[@index].OperadorCedula">
                                                            @foreach (var op in Model.ListaOperadores)
                                                            {
                                                                <option value="@op.Value" selected="@(op.Value == detalle.OperadorCedula.ToString() ? "selected" : null)">
                                                                    @op.Text
                                                                </option>
                                                            }
                                                        </select>
                                                    </td>
                                                    <td>
                                                        <input type="number" name="DetallesOperadores[@index].HorasTrabajo" value="@detalle.HorasTrabajo" class="form-control form-control-sm" step="0.1" min="0" />
                                                    </td>
                                                    <td>
                                                        <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()">Eliminar</button>
                                                    </td>
                                                </tr>
                                                index++;
                                            }
                                        }

                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="modal fade" id="modalActividades" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5>SELECCIONAR ACTIVIDADES</h5>

                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>

                                    </div>
                                    <div class="modal-body">
                                        <table class="table table-bordered display" id="tablaActividades">
                                            <thead>
                                                <tr><th style="width: 15px;">Seleccionar</th><th>Nombre</th></tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var act in Model.ListaCatalogoMantenimiento)
                                                {
                                                    <tr>
                                                        <td class="text-center">
                                                            <input type="checkbox" value="@act.Value" data-nombre="@act.Text" />
                                                        </td>
                                                        <td>@act.Text</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-success" onclick="guardarActividades()">AGREGAR SELECCIONADAS</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Repuestos -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Repuestos utilizados</label>
                            <br />
                            <button type="button" class="btn btn-outline-primary btn-sm mb-2" onclick="abrirModal()"> <i class="bi bi-plus-circle me-1"></i>REPUESTOS</button>
                            @Html.ValidationMessage("RepuestosSeleccionados", "", new { @class = "text-danger" })

                            <div class="border rounded" style="max-height: 200px; overflow-y: auto;">
                                <table class="table table-sm table-bordered mb-0" id="tablaSeleccionados">
                                    <thead class="table-light position-sticky top-0" style="z-index: 1;">
                                        <tr>
                                            <th style="background-color:white">NOMBRE</th>
                                            <th style="background-color:white">ACCIÓN</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var repuestoId in Model.RepuestosSeleccionados ?? new List<int>())
                                        {
                                            var repuesto = Model.ListaRepuestos.FirstOrDefault(r => r.Value == repuestoId.ToString());
                                            if (repuesto != null)
                                            {
                                                <tr>
                                                    <td>
                                                        @repuesto.Text
                                                        <input type="hidden" name="RepuestosSeleccionados" value="@repuesto.Value" />
                                                    </td>
                                                    <td>
                                                        <button type="button" class="btn btn-danger btn-sm" onclick="eliminarRepuesto(@repuesto.Value, this)">Eliminar</button>
                                                    </td>
                                                </tr>
                                            }
                                        }

                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="modal fade" id="modalRepuestos" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5>SELECCIONAR REPUESTOS</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <table class="table table-bordered display" id="tablaRepuestos">
                                            <thead>
                                                <tr><th style="width: 15px;">Seleccionar</th><th>Nombre</th></tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var repuesto in Model.ListaRepuestos)
                                                {
                                                    var partes = repuesto.Text.Split('|');
                                                    <tr>
                                                        <td class="text-center">
                                                            <input type="checkbox" value="@repuesto.Value" data-nombre="@partes[0]" />
                                                        </td>
                                                        <td>@partes[0]</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-success" onclick="guardarSeleccion()">AGREGAR SELECCIONADOS</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botón guardar -->
                <div class="d-flex justify-content-end gap-2 pt-3">
                    <button type="submit" class="btn btn-success w-25">GUARDAR</button>
                </div>
            </form>

        </div>
    </div>
</div>
@if (Model.RegistroMantenimiento.VehiculoId != 0)
{
    <a asp-controller="RegistroMantenimiento" asp-action="Index" asp-route-id="@Model.RegistroMantenimiento.VehiculoId"
       class="btn btn-outline-success rounded-circle shadow p-3"
       style="position: fixed; bottom: 30px; right: 30px; z-index: 1050; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
        <i class="bi bi-arrow-left"></i>
    </a>
}
else
{
    <a asp-controller="RegistroMantenimiento" asp-action="Index"
       class="btn btn-outline-success rounded-circle shadow p-3"
       style="position: fixed; bottom: 30px; right: 30px; z-index: 1050; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
        <i class="bi bi-arrow-left"></i>
    </a>
}
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Flatpickr JS + idioma español -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>

    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />

    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


    <script>
        let seleccionados = [];
        let actividadesSeleccionadas = [];
        const opcionesOperadoresHtml = `@Html.Raw(opcionesOperadores)`;

        const tareas = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ListaCatalogoMantenimiento));
        const opcionesOperadores = `@Html.Raw(opcionesOperadores)`;

        function abrirModal() {
            const modal = new bootstrap.Modal(document.getElementById("modalRepuestos"));
            modal.show();
        }


        function abrirModalActividades() {
            const modal = new bootstrap.Modal(document.getElementById("modalActividades"));
            modal.show();
        }

        function guardarActividades() {
            const checkboxes = document.querySelectorAll("#tablaActividades input[type=checkbox]:checked");
            const tabla = document.querySelector("#tablaActividadesSeleccionadas tbody");
            const rowsActuales = tabla.querySelectorAll("tr").length;
            let index = rowsActuales;

            checkboxes.forEach(cb => {
                const id = parseInt(cb.value);
                const nombre = cb.dataset.nombre;

                if (!document.getElementById(`actividad-${id}-${index}`)) {
                    const fila = document.createElement("tr");
                    fila.id = `actividad-${id}-${index}`;
                    fila.innerHTML = `
                                <td>
                                    ${nombre}
                                    <input type="hidden" name="DetallesOperadores[${index}].CatalogoMantenimientoId" value="${id}" />
                                </td>
                                <td>
                                    <select class="form-select form-select-sm" name="DetallesOperadores[${index}].OperadorCedula">
                                        ${opcionesOperadoresHtml}
                                    </select>
                                </td>
                                <td>
                                    <input type="number" name="DetallesOperadores[${index}].HorasTrabajo" class="form-control form-control-sm" min="0" step="0.1" />
                                </td>
                                <td>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()">Eliminar</button>
                                </td>`;

                    tabla.appendChild(fila);
                    index++;
                }
            });

            bootstrap.Modal.getInstance(document.getElementById("modalActividades")).hide();
        }


        function eliminarActividad(id, btn) {
            actividadesSeleccionadas = actividadesSeleccionadas.filter(x => x !== id);
            btn.closest("tr").remove();
        }

        $(document).ready(function () {
            $('#tablaActividades').DataTable({
                language: {
                    search: "Buscar:",
                    lengthMenu: "Mostrar _MENU_ actividades",
                    info: "Mostrando _START_ a _END_ de _TOTAL_ actividades",
                    paginate: { next: "Siguiente", previous: "Anterior" },
                    zeroRecords: "No se encontraron actividades"
                },
                pageLength: 10,
                lengthChange: false,
                autoWidth: false
            });
        });


        function guardarSeleccion() {
            const checkboxes = document.querySelectorAll("#tablaRepuestos input[type=checkbox]:checked");
            const tabla = document.querySelector("#tablaSeleccionados tbody");
            checkboxes.forEach(cb => {
                const id = parseInt(cb.value);
                if (!seleccionados.includes(id)) {
                    seleccionados.push(id);
                    const fila = document.createElement("tr");
                    fila.innerHTML = `
                                        <td>${cb.dataset.nombre}<input type="hidden" name="RepuestosSeleccionados" value="${id}" /></td>
                                        <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarRepuesto(${id}, this)">Eliminar</button></td>`;
                    tabla.appendChild(fila);
                }
            });
            bootstrap.Modal.getInstance(document.getElementById("modalRepuestos")).hide();
        }

        function eliminarRepuesto(id, btn) {
            seleccionados = seleccionados.filter(x => x !== id);
            btn.closest("tr").remove();
        }

        function agregarOperadorChecklist() {
            const contenedor = document.getElementById("contenedor-operadores");
            const div = document.createElement("div");
            div.className = "border p-3 mb-3 bg-light bloque-operador";
            let tareasHtml = "";
            tareas.forEach((t, i) => {
                tareasHtml += `
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input tarea-checkbox" type="checkbox" value="${t.Value}" data-text="${t.Text}" />
                                            <label class="form-check-label">${t.Text}</label>
                                        </div>
                                    </div>`;
            });
            div.innerHTML = `
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <label class="form-label">Operador</label>
                                        <select class="form-select operador-select">${opcionesOperadores}</select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Horas trabajadas</label>
                                        <input type="number" step="0.1" min="0" class="form-control horas-input" />
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Tareas realizadas</label>
                                    <div class="row">${tareasHtml}</div>
                                </div>
                                <div class="text-end">
                                    <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.bloque-operador').remove()">Eliminar</button>
                                </div>`;
            contenedor.appendChild(div);
        }

        $(document).ready(function () {
            $('#tablaRepuestos').DataTable({
                language: {
                    search: "Buscar:",
                    lengthMenu: "Mostrar _MENU_ repuestos",
                    info: "Mostrando _START_ a _END_ de _TOTAL_ repuestos",
                    paginate: { next: "Siguiente", previous: "Anterior" },
                    zeroRecords: "No se encontraron repuestos"
                },
                pageLength: 10,
                lengthChange: false,
                autoWidth: false
            });

            document.getElementById("btnAgregarOperador").addEventListener("click", agregarOperadorChecklist);

            $('form').on('submit', function (e) {
                document.querySelectorAll('.input-generado').forEach(e => e.remove());

                const contenedor = document.getElementById("contenedor-operadores");
                const bloques = contenedor.querySelectorAll(".bloque-operador");
                const tablaRepuestos = document.querySelectorAll("input[name='RepuestosSeleccionados']");
                let globalIndex = 0;

                // Validaciones generales
                if (bloques == null || bloques.length === 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Falta agregar operadores',
                        text: 'Debe agregar al menos un operador antes de continuar.'
                    });
                    e.preventDefault();
                    return;
                }

                const filasRepuestos = document.querySelectorAll("#tablaSeleccionados tbody tr");
                if (filasRepuestos == null || filasRepuestos.length === 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Repuestos requeridos',
                        text: 'Debe seleccionar al menos un repuesto antes de continuar.'
                    });
                    e.preventDefault();
                    return;
                }

                let algunError = false;

                // Validar que haya al menos una actividad registrada (desde el modal de actividades)
                const actividades = document.querySelectorAll("#tablaActividadesSeleccionadas tbody tr");
                if (actividades == null || actividades.length === 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Actividades requeridas',
                        text: 'Debe agregar al menos una actividad antes de guardar.'
                    });
                    e.preventDefault();
                    return;
                }

                bloques.forEach((bloque, bloqueIndex) => {
                    const operadorCedula = bloque.querySelector(".operador-select").value;
                    const horas = bloque.querySelector(".horas-input").value;
                    const tareasMarcadas = bloque.querySelectorAll(".tarea-checkbox:checked");

                    if (!horas || parseFloat(horas) <= 0) {
                        Swal.fire({
                            icon: 'warning',
                            title: `Horas faltantes`,
                            text: `Debe ingresar las horas trabajadas para el operador #${bloqueIndex + 1}.`
                        });
                        algunError = true;
                        return;
                    }

                    if (tareasMarcadas == null || tareasMarcadas.length === 0) {
                        Swal.fire({
                            icon: 'warning',
                            title: `Tareas requeridas`,
                            text: `Debe seleccionar al menos una tarea para el operador #${bloqueIndex + 1}.`
                        });
                        algunError = true;
                        return;
                    }

                    tareasMarcadas.forEach(tarea => {
                        const catalogoId = tarea.value;

                        const hiddenOperador = document.createElement("input");
                        hiddenOperador.type = "hidden";
                        hiddenOperador.name = `DetallesOperadores[${globalIndex}].OperadorCedula`;
                        hiddenOperador.value = operadorCedula;
                        hiddenOperador.classList.add("input-generado");

                        const hiddenHoras = document.createElement("input");
                        hiddenHoras.type = "hidden";
                        hiddenHoras.name = `DetallesOperadores[${globalIndex}].HorasTrabajo`;
                        hiddenHoras.value = horas;
                        hiddenHoras.classList.add("input-generado");

                        const hiddenCatalogo = document.createElement("input");
                        hiddenCatalogo.type = "hidden";
                        hiddenCatalogo.name = `DetallesOperadores[${globalIndex}].CatalogoMantenimientoId`;
                        hiddenCatalogo.value = catalogoId;
                        hiddenCatalogo.classList.add("input-generado");

                        document.forms[0].appendChild(hiddenOperador);
                        document.forms[0].appendChild(hiddenHoras);
                        document.forms[0].appendChild(hiddenCatalogo);

                        globalIndex++;
                    });
                });

                if (algunError) {
                    e.preventDefault(); // Cancelar envío del formulario si hay errores
                }
            });


        });

        $('.select2').select2({
            width: '100%',
            placeholder: '-- Seleccione una opción --',
            allowClear: true,
            language: "es"
        });


        flatpickr("#fechaMantenimiento", {
            locale: "es",
            dateFormat: "Y-m-d",
            defaultDate: "today"
        });
    </script>
}

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
